import java.io.File;
import java.io.FileNotFoundException;
import java.sql.*;
import java.util.Scanner;

/* ΠΡΕΠΕΙ ΝΑ ΕΛΕΓΞΕΙΣ ΤΟΝ ΚΩΔΙΚΑ, ΕΧΕΙ ΛΑΘΗ */
public class ExpImporter {

    private static final String DB_URL = "jdbc:sqlite:budgetDB.db";

    public static void importer() {
        // Πίνακες και τύποι CSV
        int[] years = {2023, 2024, 2025};
        String[] cashflowTypes = {"Esoda", "Exoda"};

        // Διαγράφουμε και εισάγουμε πρώτα foreis
        for (int year : years) {
            String filename = "B" + (year - 2000) + "Foreis.csv";
            insertForeisFromCsv(filename);
        }

        // Διαγράφουμε και εισάγουμε cashflows
        for (int year : years) {
            for (String type : cashflowTypes) {
                String filename = "B" + (year - 2000) + type + ".csv";
                insertCashflowsFromCsv(filename, type);
            }
        }
    }

    public static void insertForeisFromCsv(String filename) {
        try (Connection conn = DriverManager.getConnection(DB_URL)) {
            conn.setAutoCommit(false);

            try (Statement stmt = conn.createStatement()) {
                // Καθαρίζουμε τον πίνακα για να αποφύγουμε διπλές εγγραφές
                stmt.executeUpdate("DELETE FROM foreis");
            }

            String sql = "INSERT INTO foreis (foreas_id, year_id, regular_budget, public_inv_budget, total) " +
                         "VALUES (?, ?, ?, ?, ?)";
            try (PreparedStatement pstmt = conn.prepareStatement(sql);
                 Scanner sc = new Scanner(new File(filename))) {

                if (sc.hasNextLine()) sc.nextLine(); // Παράβλεψη header

                while (sc.hasNextLine()) {
                    String[] parts = sc.nextLine().split(",");
                    pstmt.setInt(1, Integer.parseInt(parts[0]));
                    pstmt.setInt(2, Integer.parseInt(parts[1]));
                    pstmt.setDouble(3, Double.parseDouble(parts[2]));
                    pstmt.setDouble(4, Double.parseDouble(parts[3]));
                    pstmt.setDouble(5, Double.parseDouble(parts[4]));
                    pstmt.addBatch();
                }

                pstmt.executeBatch();
                conn.commit();
                System.out.println("Εισήχθησαν δεδομένα από " + filename);

            } catch (FileNotFoundException e) {
                conn.rollback();
                System.out.println("Αρχείο όχι βρέθηκε: " + filename);
            }

        } catch (SQLException e) {
            System.out.println("Σφάλμα κατά την εισαγωγή στο foreis: " + e.getMessage());
        }
    }

    public static void insertCashflowsFromCsv(String filename, String type) {
        try (Connection conn = DriverManager.getConnection(DB_URL)) {
            conn.setAutoCommit(false);

            try (Statement stmt = conn.createStatement()) {
                // Καθαρίζουμε τον πίνακα για να αποφύγουμε διπλές εγγραφές
                stmt.executeUpdate("DELETE FROM cashflows");
            }

            String sql = "INSERT INTO cashflows (year_id, type, name, amount) VALUES (?, ?, ?, ?)";
            try (PreparedStatement pstmt = conn.prepareStatement(sql);
                 Scanner sc = new Scanner(new File(filename))) {

                if (sc.hasNextLine()) sc.nextLine(); // Παράβλεψη header

                while (sc.hasNextLine()) {
                    String[] parts = sc.nextLine().split(",");
                    pstmt.setInt(1, Integer.parseInt(parts[0])); // year_id από CSV
                    pstmt.setString(2, type);                   // τύπος Esoda/Exoda
                    pstmt.setString(3, parts[1]);              // name
                    pstmt.setDouble(4, Double.parseDouble(parts[2])); // amount
                    pstmt.addBatch();
                }

                pstmt.executeBatch();
                conn.commit();
                System.out.println("Εισήχθησαν δεδομένα από " + filename);

            } catch (FileNotFoundException e) {
                conn.rollback();
                System.out.println("Αρχείο όχι βρέθηκε: " + filename);
            }

        } catch (SQLException e) {
            System.out.println("Σφάλμα κατά την εισαγωγή στο cashflows: " + e.getMessage());
        }
    }
}
