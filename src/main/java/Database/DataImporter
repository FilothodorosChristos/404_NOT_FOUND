import java.io.File;
import java.io.FileNotFoundException;
import java.sql.*;
import java.util.Scanner;
//CHECK FOR ERRORS!!!

public class DataImporter {

    private static final String url = "jdbc:sqlite:budgetDB.db";
    /*private static boolean foreisCleared = false;
    private static boolean cashflowsCleared = false; */

    public static void importer() {
        // Γέμισμα πινάκων
        int[] years = {23, 24, 25};
        String[] cashflowTypes = {"Esoda", "Exoda"};

        // Διαγράφουμε και εισάγουμε πρώτα foreis
        for (int year : years) {
            String filename = "B" + year + "Foreis.csv";
            insertForeisFromCsv(filename);
        }

        // Διαγράφουμε και εισάγουμε cashflows
        for (int year : years) {
            for (String type : cashflowTypes) {
                String filename = "B" + year + type + ".csv";
                insertCashflowsFromCsv(filename, type);
            }
        }
    }

    public static void insertForeisFromCsv(String filename) {
        try (Connection conn = DriverManager.getConnection(url)) {
            conn.setAutoCommit(false);

            /*  Διαγραφή μόνο την πρώτη φορά που εισάγουμε foreis
            if (!foreisCleared) {
                try (Statement stmt = conn.createStatement()) {
                    stmt.executeUpdate("DELETE FROM foreis");
                }
                foreisCleared = true;
            } */

            String sql = "INSERT INTO foreis (foreas_id, year_id, type, name, regular_budget, public_inv_budget, total) " +
                         "VALUES (?, ?, ?, ?, ?, ?, ?)";
            try (PreparedStatement pstmt = conn.prepareStatement(sql);
                 Scanner myScanner = new Scanner(new File(filename))) {

                if (myScanner.hasNextLine()) myScanner.nextLine(); // Παράβλεψη header

                int lineNo = 1;
                while (myScanner.hasNextLine()) {
                    lineNo++;
                    String line = myScanner.nextLine().trim();
                    if (line.isEmpty()) continue;
                    String[] parts = line.split(",", -1);
                    if (parts.length < 7) {
                        System.out.println("Παράλειψη γραμμής " + lineNo + " στο " + filename + " (μη έγκυρη μορφή)");
                        continue;
                    }
                    try {
                        pstmt.setInt(1, Integer.parseInt(parts[0].trim()));
                        pstmt.setInt(2, Integer.parseInt(parts[1].trim()));
                        pstmt.setString(3, parts[2].trim());
                        pstmt.setString(4, parts[3].trim());
                        pstmt.setDouble(5, Double.parseDouble(parts[4].trim()));
                        pstmt.setDouble(6, Double.parseDouble(parts[5].trim()));
                        pstmt.setDouble(7, Double.parseDouble(parts[6].trim()));
                        pstmt.addBatch();
                    } catch (NumberFormatException nfe) {
                        System.out.println("Παράλειψη γραμμής " + lineNo + " στο " + filename + " (αριθμητικό σφάλμα): " + nfe.getMessage());
                    }
                }

                pstmt.executeBatch();
                conn.commit();
                System.out.println("Εισήχθησαν δεδομένα από " + filename);

            } catch (FileNotFoundException e) {
                conn.rollback();
                System.out.println("Δεν βρέθηκε το αρχείο: " + filename);
            } catch (SQLException e) {
                conn.rollback();
                System.out.println("Σφάλμα κατά την εισαγωγή στον πίνακα foreis: " + e.getMessage());
            }

        } catch (SQLException e) {
            System.out.println("Σφάλμα κατά τη σύνδεση ή το commit: " + e.getMessage());
        }
    }

    public static void insertCashflowsFromCsv(String filename, String type) {
        try (Connection conn = DriverManager.getConnection(url)) {
            conn.setAutoCommit(false);

            /*  Διαγραφή μόνο την πρώτη φορά που εισάγουμε cashflows
            if (!cashflowsCleared) {
                try (Statement stmt = conn.createStatement()) {
                    stmt.executeUpdate("DELETE FROM cashflows");
                }
                cashflowsCleared = true;
            } */

            String sql = "INSERT INTO cashflows (year_id, type, name, amount) VALUES (?, ?, ?, ?)";
            try (PreparedStatement pstmt = conn.prepareStatement(sql);
                 Scanner myScanner = new Scanner(new File(filename))) {

                if (myScanner.hasNextLine()) sc.nextLine(); // Παράβλεψη header

                int lineNo = 1;
                while (myScanner.hasNextLine()) {
                    lineNo++;
                    String line = myScanner.nextLine().trim();
                    if (line.isEmpty()) continue;
                    String[] parts = line.split(",", -1);
                    if (parts.length < 3) {
                        System.out.println("Παράλειψη γραμμής " + lineNo + " στο " + filename + " (μη έγκυρη μορφή)");
                        continue;
                    }
                    try {
                        pstmt.setInt(1, Integer.parseInt(parts[0].trim()));
                        pstmt.setString(2, type);
                        pstmt.setString(3, parts[1].trim());
                        pstmt.setDouble(4, Double.parseDouble(parts[2].trim()));
                        pstmt.addBatch();
                    } catch (NumberFormatException nfe) {
                        System.out.println("Παράλειψη γραμμής " + lineNo + " στο " + filename + " (αριθμητικό σφάλμα): " + nfe.getMessage());
                    }
                }

                pstmt.executeBatch();
                conn.commit();
                System.out.println("Εισήχθησαν δεδομένα από " + filename);

            } catch (FileNotFoundException e) {
                conn.rollback();
                System.out.println("Δεν βρέθηκε το αρχείο: " + filename);
            } catch (SQLException e) {
                conn.rollback();
                System.out.println("Σφάλμα κατά την εισαγωγή στο cashflows: " + e.getMessage());
            }

        } catch (SQLException e) {
            System.out.println("Σφάλμα κατά τη σύνδεση ή το commit: " + e.getMessage());
        }
    }
}
